include:
  - local: ".gitlab/caches.yml"
  - local: ".gitlab/setup_langs.yml"

.pg-service: &pg-service
  - name: postgres:15
    alias: pg

.setup-script: &setup-script
  - !reference [.setup-langs, script]
  # This has to come late because we need CI_SERVICE_pg defined
  - export DATABASE_URL="postgres://postgres:${POSTGRES_PASSWORD}@${CI_SERVICE_pg}:5432/rtci_test"
  - bin/rails db:create
  - bundle exec rake assets:precompile
  - bundle exec rake db:schema:load

.setup-project:
  services:
    - <<: *pg-service
  before_script:
    - <<: *setup-script

.init-project-build:
  cache:
    - !reference [.cache-ruby]
    - !reference [.cache-yarn]
    - !reference [.cache-assets-pull-push]
  services:
    - <<: *pg-service
  script:
    - <<: *setup-script
